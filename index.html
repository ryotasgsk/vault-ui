<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenPGP Decrypt (local)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    textarea { width: 100%; height: 140px; }
    #out { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 120px; }
    .row { margin: 10px 0; }
  </style>
</head>

<body>
  <h2>PGP復号（ローカルHTML）</h2>

  <div class="row">
    <label><b>1) 暗号文ファイル（ASCII armorの .gpg / .asc）</b></label><br/>
    <input id="msgFile" type="file" />
    <div style="font-size: 12px; opacity: .8;">
      先頭が <code>-----BEGIN PGP MESSAGE-----</code> のファイルを選んでください
    </div>
  </div>

  <div class="row">
    <label><b>2) 秘密鍵（ASCII）</b>（貼り付け）</label>
    <textarea id="privKey" placeholder="-----BEGIN PGP PRIVATE KEY BLOCK----- ..."></textarea>
  </div>

  <div class="row">
    <label><b>3) パスフレーズ</b></label><br/>
    <input id="pass" type="password" style="width: 100%;" placeholder="秘密鍵のパスフレーズ" />
  </div>

  <div class="row">
    <button id="btn">Decrypt</button>
  </div>

  <h3>結果（平文）</h3>
  <div id="out"></div>

  <script type="module">
    // OpenPGP.js (ESM) をCDNから読み込み（バージョン固定推奨）
    import * as openpgp from "https://cdn.jsdelivr.net/npm/openpgp@6.3.0/dist/openpgp.mjs";

    const msgFile = document.getElementById('msgFile');
    const privKey = document.getElementById('privKey');
    const pass = document.getElementById('pass');
    const out = document.getElementById('out');
    const btn = document.getElementById('btn');

    async function readFileAsText(file) {
      return await file.text();
    }

  btn.addEventListener('click', async () => {
    const out = document.getElementById('out');
    out.textContent = '';

  try {
    // === 1. 入力ファイル ===
    const file = document.getElementById('msgFile').files[0];
    if (!file) throw new Error("暗号化ファイルを選択してください");

    const armoredMessage = await file.text();

    // === 2. 秘密鍵 ===
    const privateKeyArmored = document.getElementById('privKey').value.trim();
    const passphrase = document.getElementById('pass').value;

    if (!privateKeyArmored) {
      throw new Error("秘密鍵が入力されていません");
    }

    const privateKey = await openpgp.readPrivateKey({
      armoredKey: privateKeyArmored
    });

    const decryptedPrivateKey = await openpgp.decryptKey({
      privateKey,
      passphrase
    });

    // === 3. メッセージ読み込み ===
    const message = await openpgp.readMessage({
      armoredMessage
    });

    // === 4. ファイル種別判定 ===
    const isImage =
      file.name.endsWith('.png.gpg') ||
      file.name.endsWith('.jpg.gpg') ||
      file.name.endsWith('.jpeg.gpg');

    if (isImage) {
      // ===== 画像 =====
      const { data: binaryData } = await openpgp.decrypt({
        message,
        decryptionKeys: decryptedPrivateKey,
        format: 'binary'
      });

      const mime =
        file.name.endsWith('.png.gpg') ? 'image/png' : 'image/jpeg';

      const blob = new Blob([binaryData], { type: mime });
      const url = URL.createObjectURL(blob);

      // 表示
      const img = document.createElement('img');
      img.src = url;
      img.style.maxWidth = '100%';
      img.style.border = '1px solid #ccc';
      out.appendChild(img);

      // 保存リンク
      const a = document.createElement('a');
      a.href = url;
      a.download = file.name.replace(/\.gpg$/, '');
      a.textContent = '画像を保存';
      a.style.display = 'block';
      a.style.marginTop = '8px';
      out.appendChild(a);

    } else {
      // ===== テキスト =====
      const { data: textData } = await openpgp.decrypt({
        message,
        decryptionKeys: decryptedPrivateKey,
        format: 'utf8'
      });

      out.textContent = textData;
    }

  } catch (e) {
    out.textContent = "エラー: " + (e.message ?? e);
  }
});


  </script>
</body>
</html>
